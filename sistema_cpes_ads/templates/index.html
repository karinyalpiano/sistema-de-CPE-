<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Invent√°rio de CPEs - Provedor ADS</title>

  <script>
    (function () {
      try {
        var saved = (localStorage.getItem('theme') || '').toLowerCase();
        var initial = (saved === 'light' || saved === 'dark')
          ? saved
          : ((window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', initial);
        document.documentElement.style.colorScheme = initial;
        if (!(saved === 'light' || saved === 'dark')) localStorage.setItem('theme', initial);
      } catch (e) {}
    })();
  </script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.dataTables.min.css">

  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" type="image/png">

  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <style>
    body { margin: 0; position: relative; }

    /* ===== Canvas do efeito de fundo ===== */
    .page-fx{
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      opacity: .45;
    }
    :root[data-theme="light"] .page-fx { opacity: .55; }
    :root[data-theme="dark"]  .page-fx { opacity: .40; }

    /* Garante conte√∫do acima do efeito */
    header.appbar, .subnav, main, footer { position: relative; z-index: 1; }

    header.appbar{
      display:grid; grid-template-columns:48px 1fr auto; align-items:center; gap:12px;
      padding:12px clamp(16px,3.8vw,32px); border-bottom:1px solid var(--border);
      background:var(--card); box-shadow:var(--shadow-sm);
    }
    header.appbar img{ border-radius:10px; }
    .brand h1{ margin:0; font-size:clamp(1.05rem,2.2vw,1.4rem); line-height:1.2; }
    .brand p{ margin:2px 0 0; color:#778198; font-size:.9rem; }

    .header-actions{ display:inline-flex; gap:12px; align-items:center; justify-self:end; }
    .logout-btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px;
      border:1px solid var(--border); background:color-mix(in srgb, var(--danger) 18%, var(--card));
      color:#fff; font-weight:700; text-decoration:none; box-shadow:var(--shadow-sm);
      transition:transform .06s, filter .2s;
    }
    .logout-btn:hover{ filter:brightness(.98); } .logout-btn:active{ transform:translateY(1px); }
    .logout-btn .dot{ width:10px; height:10px; border-radius:999px; background:#ff6b6b; box-shadow:0 0 0 3px rgba(239,68,68,.12); }

    .subnav{
      display:flex; gap:10px; align-items:center; padding:8px clamp(16px,3.8vw,32px);
      border-bottom:1px solid var(--border); background:var(--card);
    }
    .subnav a{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:var(--muted); color:var(--text); text-decoration:none;
      font-weight:700; font-size:13px; transition:filter .15s, transform .06s;
    }
    .subnav a:hover{ filter:brightness(.98); } .subnav a:active{ transform:translateY(1px); }

    main{ padding:clamp(16px,3.8vw,32px); display:grid; gap:22px; }

    .stats{ display:grid; grid-template-columns:repeat(3, minmax(220px,1fr)); gap:16px; }
    .stat-card{ padding:14px; display:grid; gap:6px; }
    .stat-card .kpi{ font-size:clamp(1.2rem,2.1vw,1.6rem); font-weight:800; }

    .actions-bar{ display:flex; flex-wrap:wrap; gap:12px; margin:10px 0 12px; }
    .busca-wrap{ margin-left:auto; display:inline-flex; align-items:center; gap:8px; }
    .busca-wrap input{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; padding:8px 10px; outline:none; }

    /* ====== DASHBOARD BONITA ====== */
    .health-grid{ display:grid; gap:16px; }
    .health-cards{ display:grid; grid-template-columns:repeat(3, minmax(220px,1fr)); gap:14px; }
    .health-card{ padding:14px; display:grid; gap:10px; }
    .health-card h3{ margin:0; font-size:1rem; }
    .progress{ height:10px; background:var(--muted); border:1px solid var(--border); border-radius:999px; overflow:hidden; }
    .progress > b{ display:block; height:100%; width:0%; background:linear-gradient(180deg, var(--success), #059669); transition:width .4s ease; }

    .charts-grid{ display:grid; grid-template-columns: 1fr 1fr 1.2fr; gap:16px; }
    .chart-card{ padding:14px; }
    .chart-card h4{ margin:0 0 8px; font-size: .98rem; color:#6b7280;}

    #disponibilidadeChart{ margin-top:14px; width:100%; aspect-ratio:16/6; }
    .acoes{ gap:10px !important; }

    @media (max-width: 980px) {
      .stats{ grid-template-columns:1fr; }
      .health-cards{ grid-template-columns:1fr; }
      .charts-grid{ grid-template-columns:1fr; }
      .filtros{ grid-template-columns:1fr; }
      .busca-wrap{ width:100%; justify-content:flex-start; margin:0; }
    }
  </style>
</head>

<body>
  <canvas id="indexFX" class="page-fx" aria-hidden="true"></canvas>

  <header class="appbar">
    <img src="{{ url_for('static', filename='img/favicon.png') }}" alt="CPE" width="44" height="44">
    <div class="brand">
      <h1>Invent√°rio e Status de CPEs</h1>
      <p>Projeto de Extens√£o V ‚Äî ADS</p>
    </div>
    <div class="header-actions">
      <button id="themeToggle" class="theme-toggle" type="button" aria-label="Alternar tema" aria-pressed="false" title="Alternar tema">
        <span class="icon-sun">üåû</span><span class="icon-moon">üåô</span>
      </button>
      <a class="logout-btn" href="{{ url_for('logout') }}"><span class="dot" aria-hidden="true"></span><span>Sair</span></a>
    </div>
  </header>

  <nav class="subnav" aria-label="Navega√ß√£o por se√ß√µes">
    <a href="#sec-cadastro">Cadastro</a>
    <a href="#sec-inventario">Invent√°rio</a>
    <a href="#sec-dashboard">Dashboard</a>
  </nav>

  <main>
    <section class="stats" aria-label="Resumo de Status">
      <div class="stat-card">
        <div class="kpi" id="kpiTotal">--</div>
        <small>Total de CPEs</small>
      </div>
      <div class="stat-card">
        <div class="kpi" id="kpiOnline">--</div>
        <small>Online</small>
      </div>
      <div class="stat-card">
        <div class="kpi" id="kpiOffline">--</div>
        <small>Offline/Timeout</small>
      </div>
    </section>

    <!-- Cadastro -->
    <section id="sec-cadastro" aria-labelledby="titulo-cadastro">
      <h2 id="titulo-cadastro">1) Cadastrar Novo Equipamento (CPE)</h2>

      <form id="formCadastro" novalidate>
        <fieldset>
          <legend>Dados do Cliente</legend>

          <label for="nome_cliente">Nome do Cliente/Raz√£o Social</label>
          <input type="text" id="nome_cliente" name="nome_cliente" placeholder="Nome do Cliente/Raz√£o Social" autocomplete="name" required>

          <label for="cpf_cnpj">CPF/CNPJ</label>
          <input type="text" id="cpf_cnpj" name="cpf_cnpj" placeholder="CPF/CNPJ" inputmode="numeric" autocomplete="off" maxlength="18" required>

          <label for="endereco">Endere√ßo de Instala√ß√£o</label>
          <input type="text" id="endereco" name="endereco" placeholder="Endere√ßo de Instala√ß√£o" autocomplete="street-address" required>

          <label for="telefone">Telefone (Opcional)</label>
          <input type="tel" id="telefone" name="telefone" placeholder="Telefone (Opcional)" inputmode="tel" autocomplete="tel">
        </fieldset>

        <fieldset>
          <legend>Dados do Equipamento</legend>

          <label for="serial_number">N√∫mero de S√©rie</label>
          <input type="text" id="serial_number" name="serial_number" placeholder="Ex: AX123456" required>

          <label for="modelo">Modelo do CPE</label>
          <input type="text" id="modelo" name="modelo" placeholder="Ex: Roteador C6" required>

          <label for="ip_local">Endere√ßo IP do CPE</label>
          <input type="text" id="ip_local" name="ip_local" placeholder="Ex: 192.168.1.10"
                 inputmode="numeric"
                 pattern="^((25[0-5]|2[0-4]\\d|1?\\d?\\d)(\\.|$)){4}$"
                 title="Informe um IPv4 v√°lido, ex.: 192.168.1.10" required>
        </fieldset>

        <button type="submit" id="btnCadastrar" aria-label="Cadastrar equipamento">
          <svg viewBox="0 0 24 24" aria-hidden="true" width="18" height="18"><path fill="currentColor" d="M19 13H13v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          Cadastrar equipamento
        </button>
      </form>

      <p id="mensagem" class="hidden" aria-live="polite"></p>
      <noscript>Ative o JavaScript para usar o sistema.</noscript>
    </section>

    <!-- Inventaario -->
    <section id="sec-inventario" aria-labelledby="titulo-inventario">
      <h2 id="titulo-inventario">2) Invent√°rio de Equipamentos Instalados</h2>

      <div class="actions-bar" role="group" aria-label="A√ß√µes da lista">
        <button type="button" class="btn btn--primary" id="btnAtualizar" aria-busy="false">Atualizar Lista e Status</button>
        <button type="button" class="btn btn--ghost"   id="btnExportar"  aria-label="Exportar dados para CSV">Exportar CSV</button>

        <span class="busca-wrap">
          <label for="buscaGeral" class="sr-only" style="position:absolute;left:-9999px;">Buscar</label>
          <input type="text" id="buscaGeral" placeholder="Buscar por cliente, modelo ou IP‚Ä¶">
        </span>
      </div>

      <div id="categoriaFilters" class="pill-group" role="group" aria-label="Filtrar por categoria">
        <button type="button" class="pill" data-cat="all"      aria-pressed="true">Todos</button>
        <button type="button" class="pill" data-cat="ONU"      aria-pressed="false">ONU</button>
        <button type="button" class="pill" data-cat="Roteador" aria-pressed="false">Roteador</button>
      </div>

      <div class="filtros">
        <select id="filtroCliente" aria-label="Filtrar por cliente"><option value="">Todos os clientes</option></select>
        <select id="filtroModelo"  aria-label="Filtrar por modelo"><option value="">Todos os modelos</option></select>
        <select id="filtroStatus"  aria-label="Filtrar por status"><option value="">Todos os status</option></select>
      </div>

      <table id="tabelaCPEs">
        <thead>
          <tr>
            <th>Serial Number</th><th>Modelo</th><th>Categoria</th><th>Cliente</th><th>IP Local</th><th>Status (Ping)</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- DASH -->
    <section id="sec-dashboard" aria-labelledby="titulo-dashboard" class="container">
      <h2 id="titulo-dashboard">Sa√∫de dos Equipamentos</h2>

      <div class="health-grid">
        <!-- Cards -->
        <div class="health-cards">
          <div class="health-card">
            <h3>Sa√∫de geral</h3>
            <div class="progress" aria-label="Percentual online"><b id="statusProgressBar" style="width:0%"></b></div>
            <small><span id="statusProgressValue">0%</span> online</small>
          </div>
          <div class="health-card">
            <h3>M√©dia de disponibilidade (7d)</h3>
            <div class="kpi" id="avgDisponibilidade">--</div>
            <small>Considera todos os CPEs com hist√≥rico</small>
          </div>
          <div class="health-card">
            <h3>Risco (Disponibilidade &lt; 95%)</h3>
            <div class="kpi" id="riscoCount">--</div>
            <small>Equipamentos que mais exigem aten√ß√£o</small>
          </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
          <div class="chart-card">
            <h4>Status (online vs. offline)</h4>
            <canvas id="statusPie" height="180"></canvas>
          </div>
          <div class="chart-card">
            <h4>Distribui√ß√£o por categoria</h4>
            <canvas id="categoriaPie" height="180"></canvas>
          </div>
          <div class="chart-card">
            <h4>Piores disponibilidades (7 dias)</h4>
            <canvas id="topOfflineChart" height="220"></canvas>
          </div>
        </div>
      </div>

      <h2 style="margin-top:18px">√öltimos Status (log)</h2>
      <table id="tabelaStatus">
        <thead>
          <tr>
            <th>Serial Number</th><th>Modelo</th><th>Categoria</th><th>Cliente</th><th>IP Local</th><th>Status (√öltima verifica√ß√£o)</th>
          </tr>
        </thead>
        <tbody id="statusCPEs"></tbody>
      </table>

      <h2>Disponibilidade dos Equipamentos (√öltimos 7 dias)</h2>
      <canvas id="disponibilidadeChart" aria-label="Gr√°fico de disponibilidade dos equipamentos" role="img"></canvas>
    </section>
  </main>

  <footer><p>&copy; 2025 - Projeto ADS</p></footer>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
  <script src="https://cdn.datatables.net/2.0.7/js/dataTables.min.js" defer></script>
  <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>

  <script>
    (async function loadKPIs(){
      try {
        const r = await fetch('/api/dashboard/last_status');
        if (!r.ok) return;
        const data = await r.json();
        const total = data.length;
        const online = data.filter(x => (x.status || '').toLowerCase() === 'online').length;
        const offline = total - online;
        document.getElementById('kpiTotal').textContent = total;
        document.getElementById('kpiOnline').textContent = online;
        document.getElementById('kpiOffline').textContent = offline;
      } catch(e) {}
    })();
  </script>

  <!-- Efeito(fibras opticas suaves no fundo) -->
  <script>
    (function () {
      const canvas = document.getElementById('indexFX');
      if (!canvas) return;

      const reduce = window.matchMedia && matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (reduce) { canvas.remove(); return; }

      const ctx = canvas.getContext('2d', { alpha: true });
      let W = 0, H = 0, dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      let raf = null;
      let fibers = [];
      let palette = { a:[96,165,250], b:[16,185,129] }; // fallback (blue/green)

      function readRGB(varName) {
        const s = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        if (!s) return null;
        if (s.startsWith('#')) {
          let hex = s.slice(1); if (hex.length===3) hex = hex.split('').map(c=>c+c).join('');
          const n = parseInt(hex, 16); return [(n>>16)&255, (n>>8)&255, n&255];
        }
        const m = s.match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/i);
        return m ? [ +m[1], +m[2], +m[3] ] : null;
      }
      function updatePalette() {
        palette.a = readRGB('--primary') || palette.a;
        palette.b = readRGB('--success') || palette.b;
      }

      function resize() {
        W = Math.round(innerWidth);
        H = Math.round(innerHeight);
        canvas.width = Math.floor(W*dpr);
        canvas.height = Math.floor(H*dpr);
        canvas.style.width = W+'px';
        canvas.style.height = H+'px';
        ctx.setTransform(dpr,0,0,dpr,0,0);
        spawn();
      }

      function spawn() {
        const BASE = Math.round(Math.min(28, Math.max(12, H/42))); 
        fibers = Array.from({length: BASE}, () => ({
          y: Math.random()*H,
          amp: 10 + Math.random()*60,
          k:  0.001 + Math.random()*0.0022, 
          speed: 0.6 + Math.random()*1.2,   
          xoff: -Math.random()*W,            
          thick: 0.6 + Math.random()*1.2
        }));
      }

      function mix(a,b,t){ return a + (b-a)*t; }

      function strokeGradient(y0, y1) {
        const g = ctx.createLinearGradient(0, y0, W, y1);
        const [r1,g1,b1] = palette.a, [r2,g2,b2] = palette.b;
        g.addColorStop(0,   `rgba(${r1},${g1},${b1},0.25)`);
        g.addColorStop(0.5, `rgba(${Math.round(mix(r1,r2,.5))},${Math.round(mix(g1,g2,.5))},${Math.round(mix(b1,b2,.5))},0.20)`);
        g.addColorStop(1,   `rgba(${r2},${g2},${b2},0.22)`);
        return g;
      }

      function drawFiber(f) {
        const x0 = f.xoff - 200;
        const x3 = f.xoff + W + 200;
        const x1 = x0 + (W*0.35);
        const x2 = x0 + (W*0.70);

        const t0 = (x0+W)*f.k, t1 = (x1+W)*f.k, t2 = (x2+W)*f.k, t3 = (x3+W)*f.k;
        const y0 = f.y + Math.sin(t0)*f.amp;
        const y1 = f.y + Math.sin(t1)*f.amp*0.8;
        const y2 = f.y + Math.sin(t2)*f.amp*0.6;
        const y3 = f.y + Math.sin(t3)*f.amp*0.8;

        ctx.strokeStyle = strokeGradient(y0, y3);
        ctx.lineWidth = f.thick;
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.bezierCurveTo(x1, y1, x2, y2, x3, y3);
        ctx.stroke();

        // brilho discreto (hotspot) que percorre a fibra
        const glowX = (f.xoff % (W+400)) - 200;
        const glowT = (glowX + 200) / (W+400);
        const gy = f.y + Math.sin((glowX+W)*f.k)*f.amp;
        const [r1,g1,b1] = palette.a, [r2,g2,b2] = palette.b;
        const gr = Math.round(mix(r1,r2,glowT));
        const gg = Math.round(mix(g1,g2,glowT));
        const gb = Math.round(mix(b1,b2,glowT));
        const rad = 14 * (0.4 + 0.6*Math.abs(Math.cos((glowX+W)*0.002)));
        const gdt = ctx.createRadialGradient(glowX, gy, 0, glowX, gy, rad);
        gdt.addColorStop(0, `rgba(${gr},${gg},${gb},0.22)`);
        gdt.addColorStop(1, `rgba(${gr},${gg},${gb},0.00)`);
        ctx.fillStyle = gdt;
        ctx.beginPath(); ctx.arc(glowX, gy, rad, 0, Math.PI*2); ctx.fill();
      }

      function step() {
        ctx.clearRect(0,0,W,H);

        // leve v√©u em dark pra dar contraste
        if ((document.documentElement.getAttribute('data-theme') || 'light') === 'dark') {
          ctx.fillStyle = 'rgba(2,6,23,0.10)';
          ctx.fillRect(0,0,W,H);
        }

        fibers.forEach(f => {
          drawFiber(f);
          f.xoff += f.speed;
          if (f.xoff > W+400) f.xoff = -400;
        });

        raf = requestAnimationFrame(step);
      }

      function start(){ cancelAnimationFrame(raf); updatePalette(); resize(); step(); }

      // reage a tema e redimensionamento
      const mo = new MutationObserver(()=>{ updatePalette(); });
      mo.observe(document.documentElement, { attributes:true, attributeFilter:['data-theme'] });

      window.addEventListener('resize', ()=>{ cancelAnimationFrame(raf); requestAnimationFrame(start); });
      document.addEventListener('visibilitychange', ()=>{ if (document.hidden) cancelAnimationFrame(raf); else start(); });

      start();
    })();
  </script>
</body>
</html>
